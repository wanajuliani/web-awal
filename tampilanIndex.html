<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="style.css">
    <title>Bento latihan</title>
  </head>
  <body>
    <main class="bento_box">
      <div class="bento_container" variant-1>
        <div class="bento_item" style="--rows: 3; --columns: 1">
            <div class="button-display">
            <div class="checkbox-wrapper-5">
                <div class="check">
                  <input id="checkbox-1" type="checkbox" onclick="toggleLED()">
                  <label for="checkbox-1"></label>
                </div>
              </div>
            <div class="checkbox-wrapper-5">
                <div class="check">
                  <input id="checkbox-2" type="checkbox" onclick="toggleLED()">
                  <label for="checkbox-2"></label>
                </div>
              </div>
            <div class="checkbox-wrapper-5">
                <div class="check">
                  <input id="checkbox-3" type="checkbox" onclick="toggleLED()">
                  <label for="checkbox-3"></label>
                </div>
              </div>
            </div>
        </div>
        <div class="bento_item" style="--rows: 3; --columns: span 2">
            3
        </div>
        <div class="bento_item" style="--rows: 2; --columns: 3/4">
            <div class="bar_container">
                <div class="bar_box">
                  <div class="bar_shadow"></div>
                  <div class="bar_content">
                    <div class="bar_percent" data-text="Jarak" style="--num: 0">
                      <div class="bar_dot"></div>
                      <svg>
                        <circle cx="70" cy="70" r="70"></circle>
                        <circle cx="70" cy="70" r="70"></circle>
                      </svg>
                    </div>
                    <div class="bar_number">
                      <h2 id="nilaisuhu">0 <span>C</span></h2>
                    </div>
                  </div>
                </div>
              </div>
        </div>
        <div class="bento_item" style="--rows: span 1; --columns: span 3">
          <img src="https://img1.picmix.com/output/stamp/normal/6/4/6/7/637646_3f2a5.gif" alt="Computer man">
        </div>
        <div class="bento_item" style="--rows: 1; --columns: span 3">
            <center>
                <div class="card">
                  <div class="card-text">
                    <div class="portada"></div>
                    <div class="title-total">
                      <div class="title">Siswa SMK Alfalah</div>
                      <div class="typing-demo">Wana Juliani</div>
    
                      <div class="desc">
                        Saya lahir di Bandung tanggal 11 Juli 2007. Sekarang saya
                        berumur 17 tahun
                      </div>
                      <div class="actions">
                        <button><i class="far fa-heart"></i></button>
                        <button><i class="far fa-envelope"></i></button>
                        <button><i class="fas fa-user-friends"></i></button>
                      </div>
                    </div>
                  </div>
                </div>
              </center>
        </div>
        <div class="bento_item" style="--rows: 2; --columns: span 2">
            <div class="widget_container">
                <article class="widget">
                    <div class="weatherIcon" id="weatherIcon">
                        <i class="wi wi-cloud"></i>
                    </div>
                    <div class="weatherInfo">
                        <div class="temperature" id="tempID">
                            <span>tempereature error</span>
                        </div>
                        <div class="description">
                            <div class="weatherCondition" id="conditionID"> Kondisi Error</div>
                            <div class="location" id="locationID"> Coblong, Bandung</div>
                        </div>
                    </div>
                    <div class="humid" id="humidID"> Kelembapan Error</div>
                </article>
              </div>
        </div>
      </div>
    </main>
  </body>
  <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.6/dist/umd/popper.min.js" integrity="sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.2.1/dist/js/bootstrap.min.js" integrity="sha384-B0UglyR+jN6CkvvICOB2joaf5I4l3gm9GU6Hc1og6Ls7i6U/mkkaduKaBhlAXv9k" crossorigin="anonymous"></script>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/js-polyfills/0.1.43/polyfill.min.js"></script>

  <script src="https://www.gstatic.com/firebasejs/7.20.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/7.20.0/firebase-analytics.js"></script>
  <script src="https://www.gstatic.com/firebasejs/7.20.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/7.20.0/firebase-database.js"></script>
  <script type="module"> //fungsi module ini supaya di private
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
    import { getDatabase, ref, onValue, set } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-database.js";
    // TODO: Add SDKs for Firebase products that you want to use
    // https://firebase.google.com/docs/web/setup#available-libraries

    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyC9MPGLkgx3PmyW51H5yeWU5p5nCiyGgio",
      authDomain: "cobafirebasearduino.firebaseapp.com",
      databaseURL: "https://cobafirebasearduino-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "cobafirebasearduino",
      storageBucket: "cobafirebasearduino.firebasestorage.app",
      messagingSenderId: "455802594258",
      appId: "1:455802594258:web:f74f4622057d3cdf2b9e0b"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const ledRef = ref(db, 'aktuator');
    const dhtRef = ref(db, 'Suhu');
    const usRef = ref(db, 'Sensor'); //nama tabel

    // WIDGET SCRIPT START
    //variabel untuk suhu dan kelembapan
    let humidity = 23; //nilai awal kelembapan
    let temperature = 20; //nilai awal suhu
    //variable untuk mengatur nilai suhu
    let jarakValue = 50;

    //fungsi mengganti tulisan berdasarkan suhu
    function updateWeatherCondition(tempValue){
        const conditionElement  = document.getElementById("conditionID");

        //buat mengganti tulisan
        if (tempValue > 0 && tempValue <= 19  ) {
            conditionElement.textContent = "Dingin";
        }else if(tempValue >= 20 && tempValue <= 30) {
            conditionElement.textContent = "Sedang";
        }else if (tempValue >= 31 ){
            conditionElement.textContent = "Panas";
        }
    }

    //fungsi untuk update suhu, kelembapan dan icon
    function updateWeather(humidValue, tempValue){
        const temperatureElement = document.getElementById("tempID");
        const humidElement = document.getElementById("humidID");
        const iconElement = document.getElementById("weatherIcon");

        //update suhu
        temperatureElement.innerHTML = `<span>${tempValue}&deg;C</span>`;
        //update kelembapan
        humidElement.textContent = `${humidValue}%`;
        //update icon
        let iconClass = "wi wi-refresh";
        if (humidValue >= 0 && humidValue <= 20){
            iconClass = "wi wi-day-cloudy"; //cerah 
        } else if (humidValue >= 21 && humidValue <= 50){
            iconClass = "wi wi-day-fog"; //kabut
        } else if (humidValue > 51 ){
            iconClass = "wi wi-day-thunderstorm"; //hujan gede
        }

        //untuk mengganti class
        iconElement.innerHTML = `<i class="${iconClass}"></i>`;
        updateWeatherCondition(tempValue);
    }

    // updateWeather(humidity, temperature);
    // WIDGET SCRIPT END

    //untuk mengubah status led 
    //onValue berfungsi untuk mengambil data dari firebase
    //snapshot berfungsi untuk mengambil data secara realtime
    onValue(ledRef, (snapshot) => {
      const led = snapshot.val();
      if (snapshot.exists()){
        Object.keys(led).forEach((key, index)=>{
        document.getElementById(`checkbox-${index+1}`).checked = led[key] === 1;
      });
    }console.log('status LED berubah', Object.values(led));
    });

    //untuk  dht
    onValue(dhtRef, (snapshot) => {
      if (snapshot.exists()){
        //ketika data tidak kosong maka perintah ini dijalankan
        const data = snapshot.val();
       temperature = data.t;
       humidity = data.h;
       console.log("Temperature update", temperature);
       console.log("Kelembapan update", humidity);
       updateWeather(humidity, temperature);
      } else {
        //ketika data kosong atau 0 maka data ini dijalankan
        console.log("Data DHT tidak ada");}
    }, (error) => {
      //jika error data ini yang dijalankan
      console.log("error baca data DHT");
    });

    //untuk mengambil data sensor ultrasonic
    onValue(usRef, (snapshot) => {
      if (snapshot.exists()){
        const data = snapshot.val();
        let nilaiJarak = data.jarak;
        console.log("jarak berubah", nilaiJarak);

        //untuk mengganti css --num
        const barPercentElement = document.querySelector(".bar_percent");
        barPercentElement.style.setProperty("--num", nilaiJarak);

        const percentageElement = document.getElementById("nilaisuhu");
        percentageElement.textContent = `${nilaiJarak} cm`;
      } else {
        console.log("data ultrasonic tidak ada");
      }
    });


    //window fungsinya mengubah yang tadinya private menjadi public
    window.toggleLED = () => {
      const ledState = [1, 2, 3].map(i => document.getElementById(`checkbox-${i}`).checked ? 1 : 0);
      
      set(ledRef, {
        led1: ledState[0],
        led2: ledState[1],
        led3: ledState[2]
      }).then(() => console.log("LED state updated in Firebase"))
        .catch(() => console.log("Failed to update LED state"));
    }
  </script>
</html>